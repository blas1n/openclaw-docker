services:
  # Tailscale sidecar - provides secure Tailscale network access
  tailscale:
    image: tailscale/tailscale:latest
    container_name: openclaw-tailscale
    hostname: openclaw  # This will be the Tailscale device name
    restart: unless-stopped

    # Allow access to host machine for Ollama (GPU-accelerated)
    # This is shared with openclaw container via network_mode
    extra_hosts:
      - "host.docker.internal:host-gateway"

    # Tailscale requires NET_ADMIN and NET_RAW
    cap_add:
      - NET_ADMIN
      - NET_RAW

    # Persistent Tailscale state
    volumes:
      - tailscale-state:/var/lib/tailscale
      - /dev/net/tun:/dev/net/tun

    # Tailscale configuration
    environment:
      - TS_AUTHKEY=${TS_AUTHKEY}  # Set in .env file
      - TS_STATE_DIR=/var/lib/tailscale
      - TS_USERSPACE=false
      - TS_ACCEPT_DNS=false
      - TS_EXTRA_ARGS=--advertise-tags=tag:openclaw

    # Security hardening
    security_opt:
      - no-new-privileges:true

    # Health check - ensures Tailscale Serve is configured
    healthcheck:
      test: ["CMD", "sh", "-c", "tailscale serve status | grep -q 'https://openclaw' || (TS_IP=$$(tailscale ip -4) && tailscale serve --https=443 --bg http://$$TS_IP:18789 >/dev/null 2>&1); exit 0"]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 30s

  # Init container - copies Docker CLI binary into shared volume
  docker-cli-init:
    image: docker:27-cli
    container_name: openclaw-docker-cli-init
    restart: "no"
    volumes:
      - docker-cli:/out
    entrypoint: ["sh", "-c", "cp /usr/local/bin/docker /out/docker && chmod 755 /out/docker"]

  # Docker-in-Docker (rootless) - isolated Docker daemon for sandbox containers
  # Sandbox containers run INSIDE this daemon, fully isolated from host Docker.
  # Both OpenClaw and DinD mount ./data at the same path (/home/node/.openclaw),
  # so bind mount paths resolve correctly without host-specific paths.
  dind:
    image: docker:27-dind
    container_name: openclaw-dind
    restart: unless-stopped
    # privileged required: rootless DinD fails on Docker Desktop VM (linuxkit kernel)
    # Still safer than DooD: sandbox escape only reaches DinD, not host Docker
    privileged: true
    volumes:
      - ./data:/home/node/.openclaw:rw          # Same path as OpenClaw sees
      - dind-data:/var/lib/docker  # Persistent image cache
    environment:
      - DOCKER_TLS_CERTDIR=  # Disable TLS, listen on tcp://0.0.0.0:2375
    # Expose only on localhost - OpenClaw reaches via host.docker.internal
    ports:
      - "127.0.0.1:2375:2375"

  # OpenClaw - uses Tailscale's network
  openclaw:
    image: ghcr.io/openclaw/openclaw:latest
    container_name: openclaw
    user: "1000:1000"
    restart: unless-stopped

    # Use Tailscale sidecar's network (all traffic routes through Tailscale)
    # Note: extra_hosts is configured on tailscale service (network provider)
    # OpenClaw inherits the network configuration including host.docker.internal
    network_mode: "service:tailscale"
    depends_on:
      tailscale:
        condition: service_started
      docker-cli-init:
        condition: service_completed_successfully
      dind:
        condition: service_started

    # Security hardening
    security_opt:
      - no-new-privileges:true
    read_only: true
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE

    # Tmpfs for runtime-only writable directories
    tmpfs:
      - /tmp:mode=1777,size=1G
      - /home/node/.npm:mode=755,size=512M
      - /home/node/.cache:mode=755,size=512M

    # Volumes for persistent data
    volumes:
      - ./data:/home/node/.openclaw:rw
      - ./logs:/var/log/openclaw:rw
      - docker-cli:/usr/local/sbin:ro

    # No port mapping needed - accessible via Tailscale IP
    # Access: http://<tailscale-ip>:18789

    # Environment variables
    env_file:
      - .env

    # Additional environment variables
    environment:
      - NODE_ENV=production
      - DOCKER_HOST=tcp://host.docker.internal:2375

    # Health check
    # Dynamically detects Tailscale IP from fib_trie (openclaw binds to 'lan', not localhost)
    healthcheck:
      test: ["CMD", "sh", "-c", "TS_IP=$$(grep -B 1 'host LOCAL' /proc/net/fib_trie | grep '|-- 100\\.' | grep -oP '100\\.\\d+\\.\\d+\\.\\d+'); wget -q -O - http://$$TS_IP:18789/health > /dev/null || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

volumes:
  tailscale-state:
    driver: local
  docker-cli:
    driver: local
  dind-data:
    driver: local
